# Дашборд регионов России

## Описание

Этот проект — интерактивное веб‑приложение на базе фреймворка [Dash](https://dash.plotly.com/) для визуализации данных по регионам России.

Основные возможности:
- отображение карты России с регионами (GeoJSON‑геометрия);
- выбор региона и просмотр детализированной информации о нём;
- отображение аналитических показателей на основе подготовленных данных (`app/data/analytic`);
- навигация между страницами (главная, по регионам, архив и др.) через механизмы **Dash Pages**.

Приложение предназначено как учебный и демонстрационный пример архитектуры Dash‑проекта с:
- разбиением на страницы;
- отдельным слоем загрузки и подготовки данных (`data_loader`);
- базовыми автотестами и линтингом (flake8, wemake-python-styleguide, mypy, pytest).


## Архитектура

### Общий обзор

Приложение организовано как пакет `app` с точкой входа [`app/app.py`](app/app.py) и набором страниц в каталоге [`app/pages`](app/pages). Для работы с данными и геометрией регионов используется сервисный слой в [`app/services`](app/services).

Ключевые элементы архитектуры:

1. **Dash + Dash Pages**
   - В файле [`app/app.py`](app/app.py) создаётся объект `Dash` и включается поддержка страниц (Dash Pages).
   - Страницы описаны в модулях каталога [`app/pages`](app/pages):
     - [`app/pages/home.py`](app/pages/home.py) — главная страница с интерактивной картой России;
     - [`app/pages/region.py`](app/pages/region.py) — страница с деталями по конкретному региону.
   - Callbacks определены непосредственно в модулях страниц.

2. **Модели данных**

   - [`app/models.py`](app/models.py) — Pydantic модели для валидации данных:
     - `AnalyticRecord` — модель для аналитических данных из CSV;
     - `OrganizationRecord` — модель для данных об организациях из CSV;
     - `GeoJSONFeature`, `GeoJSONFeatureCollection` — модели для валидации GeoJSON данных.

3. **Сервисный слой**

   Сервисный слой инкапсулирует логику загрузки и подготовки данных:

   - [`app/services/csv_loader.py`](app/services/csv_loader.py) — загрузчик CSV файлов с валидацией:
     - `load_analytic_data()` — загрузка аналитических данных из `app/data/analytic/data.csv`;
     - `load_organizations_data()` — загрузка данных об организациях из `app/data/analytic/organizations.csv` с расчетом метрик (staffing, cash_use, serviceability) и колонки `value` (минимум из трех метрик);
     - `load_csv()` — универсальный метод для загрузки CSV с валидацией через Pydantic модели.

   - [`app/services/geojson_loader.py`](app/services/geojson_loader.py) — загрузчик GeoJSON файлов:
     - `load_and_validate_geojson_file()` — загрузка и валидация одного GeoJSON файла;
     - `GeoJSONLoader` — класс для загрузки всех регионов из каталога.

   - [`app/services/data_loader.py`](app/services/data_loader.py) — основной загрузчик данных:
     - `DataLoader` — класс, объединяющий геоданные и данные организаций в единый GeoDataFrame;
     - мерджит геометрию регионов (GeoJSON) с данными организаций по полю `region`;
     - предоставляет готовый `gdf` (GeoDataFrame) для использования в визуализации.

   Такой подход позволяет отделить бизнес‑логику от представления и упростить тестирование.

4. **Конфигурация**

   - [`app/config.py`](app/config.py) — конфигурационные параметры приложения (пути к данным, параметры запуска и т.п.).

5. **Данные**

   - [`app/data/analytic`](app/data/analytic) — табличные аналитические данные в CSV:
     - `data.csv` — аналитические данные по регионам;
     - `organizations.csv` — данные об организациях по регионам.
   - [`app/data/regions`](app/data/regions) — геоданные по регионам в формате GeoJSON:
     - отдельные файлы для каждого региона (например, `Adygeya.geojson`, `Moskva.geojson`);
     - [`app/data/regions/config`](app/data/regions/config) — конфигурационные файлы (regions_names.json, russia_regions.geojson, Russia.geojson).

6. **Тесты**

   - Каталог [`tests`](tests) содержит автоматические тесты:
     - [`tests/test_data_loader.py`](tests/test_data_loader.py) — тесты для сервисов загрузки данных (проверка корректности чтения CSV/GeoJSON, сопоставления регионов, валидации данных и т.д.).


## Структура проекта

Основные элементы дерева проекта:

```text
.
├── app/
│   ├── app.py              # Точка входа Dash-приложения
│   ├── config.py           # Конфигурация приложения
│   ├── models.py           # Pydantic модели для валидации данных
│   ├── data/
│   │   ├── analytic/
│   │   │   ├── data.csv              # Аналитические данные по регионам
│   │   │   └── organizations.csv    # Данные об организациях
│   │   └── regions/
│   │       ├── *.geojson            # Геометрия отдельных регионов
│   │       └── config/
│   │           ├── regions_names.json
│   │           ├── russia_regions.geojson
│   │           └── Russia.geojson
│   ├── pages/
│   │   ├── __init__.py
│   │   ├── home.py                  # Главная страница с картой России
│   │   └── region.py                # Страница деталей региона
│   └── services/
│       ├── __init__.py
│       ├── csv_loader.py            # Загрузчик CSV с валидацией
│       ├── geojson_loader.py        # Загрузчик GeoJSON файлов
│       └── data_loader.py           # Основной загрузчик данных
├── tests/
│   ├── __init__.py
│   ├── test_data_loader.py          # Тесты для сервисов загрузки данных
│   └── test_asgi_app.py              # Тесты для ASGI приложения (uvicorn)
├── pyproject.toml          # Зависимости (uv) и базовая конфигурация
├── setup.cfg               # Настройки инструментов (flake8, mypy и др.)
├── uv.lock                 # Lock-файл зависимостей для uv
├── Dockerfile              # Конфигурация Docker образа
├── docker-compose.yml      # Конфигурация Docker Compose для деплоя
├── .dockerignore           # Исключения для Docker сборки
└── README.md
```


## Запуск приложения

Ниже предполагается, что у вас установлен Python 3.11+ и инструмент [uv](https://github.com/astral-sh/uv) (если проект на нём). Если вы используете `pip`, шаги по установке пакетов будут немного отличаться.

### 1. Клонирование репозитория

```bash
git clone <URL_РЕПОЗИТОРИЯ>
cd dashbord
```

### 2. Установка зависимостей

Через **uv** (рекомендуется, если проект уже настроен под uv, см. [`pyproject.toml`](pyproject.toml) и [`uv.lock`](uv.lock)):

```bash
uv sync
```

Через **pip** (альтернативный вариант):

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -e .  # установка из pyproject.toml
```

### 3. Запуск Dash-приложения через uvicorn

Приложение настроено для работы с **uvicorn** ASGI сервером. Это обеспечивает лучшую производительность и возможность масштабирования.

#### Вариант 1: Запуск через модуль app.py (рекомендуется)

```bash
# через uv
uv run python -m app.app

# либо напрямую
python -m app.app
```

#### Вариант 2: Запуск через uvicorn напрямую

```bash
# через uv
uv run uvicorn app.app:asgi_app --host 0.0.0.0 --port 8000

# либо напрямую
uvicorn app.app:asgi_app --host 0.0.0.0 --port 8000
```

#### Настройка через переменные окружения

Вы можете настроить параметры сервера через переменные окружения (создайте файл `.env` в корне проекта):

```bash
UVICORN_HOST=0.0.0.0
UVICORN_PORT=8000
UVICORN_WORKERS=1
UVICORN_RELOAD=false
```

Или установите их перед запуском:

```bash
export UVICORN_HOST=0.0.0.0
export UVICORN_PORT=8000
uv run python -m app.app
```

#### Дополнительные опции uvicorn

Для production окружения рекомендуется использовать несколько workers:

```bash
uvicorn app.app:asgi_app --host 0.0.0.0 --port 8000 --workers 4
```

Для разработки с автоматической перезагрузкой:

```bash
uvicorn app.app:asgi_app --host 0.0.0.0 --port 8000 --reload
```

После запуска приложение будет доступно по адресу, указанному в логах (по умолчанию http://0.0.0.0:8000/ или http://127.0.0.1:8000/).


## Деплой через Docker

Проект включает конфигурацию Docker для удобного деплоя и запуска приложения в контейнере.

### Требования

- [Docker](https://www.docker.com/get-started) версии 20.10 или выше
- [Docker Compose](https://docs.docker.com/compose/install/) версии 2.0 или выше

### Быстрый старт

#### Режимы запуска

Docker Compose поддерживает два основных режима запуска:

**1. Тихий запуск (фоновый режим) — рекомендуется для production**

Контейнер запускается в фоновом режиме, терминал остается свободным:

```bash
# Запуск в фоновом режиме
docker-compose up -d

# Запуск с пересборкой образа в фоновом режиме
docker-compose up -d --build
```

Преимущества:
- Терминал остается свободным для других команд
- Контейнер продолжает работать после закрытия терминала
- Подходит для production окружения

После запуска приложение будет доступно по адресу `http://localhost:8000`.

**2. Запуск с логами в реальном времени (онлайн режим) — для разработки и отладки**

Все логи выводятся в терминал в реальном времени:

```bash
# Запуск с выводом всех логов
docker-compose up

# Запуск с пересборкой и выводом логов
docker-compose up --build
```

Преимущества:
- Видны все логи приложения в реальном времени
- Удобно для отладки и разработки
- Автоматическая остановка при нажатии `Ctrl+C`

Для остановки нажмите `Ctrl+C` в терминале.

#### Просмотр логов после тихого запуска

Если контейнер запущен в фоновом режиме, логи можно просмотреть отдельно:

```bash
# Все логи в реальном времени
docker-compose logs -f

# Логи конкретного сервиса
docker-compose logs -f dashbord

# Последние 100 строк логов
docker-compose logs --tail=100

# Логи с временными метками
docker-compose logs -f -t
```

#### Остановка контейнера

```bash
# Остановка контейнера (если запущен в фоновом режиме)
docker-compose stop

# Остановка и удаление контейнера
docker-compose down

# Остановка с удалением volumes (осторожно!)
docker-compose down -v
```

### Настройка через переменные окружения

Создайте файл `.env` в корне проекта для настройки параметров:

```bash
# Настройки uvicorn сервера
UVICORN_HOST=0.0.0.0
UVICORN_PORT=8000
UVICORN_WORKERS=1
UVICORN_RELOAD=false
```

Переменные из `.env` файла автоматически подхватываются docker-compose.

### Основные команды

#### Сборка образа

```bash
# Сборка образа
docker-compose build

# Пересборка без кеша
docker-compose build --no-cache
```

#### Управление контейнером

```bash
# Перезапуск контейнера
docker-compose restart

# Перезапуск с пересборкой образа
docker-compose up -d --build

# Пауза контейнера (без остановки)
docker-compose pause

# Возобновление после паузы
docker-compose unpause

# Остановка без удаления
docker-compose stop

# Остановка и удаление контейнера
docker-compose down
```

> **Примечание:** Подробнее о режимах запуска см. раздел [Режимы запуска](#режимы-запуска) выше.

#### Просмотр состояния и логов

```bash
# Статус контейнеров
docker-compose ps

# Логи в реальном времени
docker-compose logs -f

# Логи конкретного сервиса
docker-compose logs -f dashbord

# Последние 100 строк логов
docker-compose logs --tail=100
```

#### Выполнение команд внутри контейнера

```bash
# Запуск shell в контейнере
docker-compose exec dashbord /bin/bash

# Выполнение команды Python
docker-compose exec dashbord uv run python -m app.app

# Запуск тестов
docker-compose exec dashbord uv run pytest
```

### Структура Docker конфигурации

- **`Dockerfile`** — определение образа приложения:
  - Базовый образ: Python 3.11-slim
  - Установка системных зависимостей (GDAL для геопространственных библиотек)
  - Установка зависимостей через `uv`
  - Настройка рабочего окружения
  - Запуск через uvicorn

- **`docker-compose.yml`** — оркестрация сервисов:
  - Сервис `dashbord` с автоматической сборкой
  - Проброс портов
  - Монтирование данных (только чтение)
  - Healthcheck для проверки работоспособности
  - Автоматический перезапуск при сбоях

- **`.dockerignore`** — исключения при сборке образа (кеш Python, виртуальные окружения, IDE файлы и т.д.)

### Production настройки

Для production окружения рекомендуется:

1. **Увеличить количество workers:**

Создайте `.env` файл:
```bash
UVICORN_WORKERS=4
```

2. **Использовать внешний reverse proxy** (nginx, traefik) для:
   - SSL/TLS терминации
   - Статической раздачи файлов
   - Балансировки нагрузки

3. **Настроить мониторинг и логирование** через внешние сервисы

### Обновление данных без пересборки

Данные монтируются как volume в режиме только чтения (`./app/data:/app/app/data:ro`), что позволяет обновлять данные без пересборки образа:

```bash
# Обновить данные
# (просто замените файлы в ./app/data/)

# Перезапустить контейнер для применения изменений
docker-compose restart
```

### Устранение проблем

#### Контейнер не запускается

```bash
# Проверить логи
docker-compose logs dashbord

# Проверить статус
docker-compose ps
```

#### Порт уже занят

Измените порт в `.env` файле:
```bash
UVICORN_PORT=8080
```

#### Проблемы с зависимостями

Пересоберите образ без кеша:
```bash
docker-compose build --no-cache
docker-compose up -d
```

#### Проверка healthcheck

```bash
# Проверить статус healthcheck
docker inspect dashbord-app | grep -A 10 Health
```


## Тестирование

Для тестов используется **pytest** с поддержкой асинхронных тестов через **pytest-asyncio**. Тесты лежат в каталоге [`tests`](tests).

### Структура тестов

Проект включает два типа тестов:

1. **Тесты загрузки данных** ([`tests/test_data_loader.py`](tests/test_data_loader.py)):
   - Тесты для `DataLoader` — проверка загрузки и объединения GeoJSON и CSV данных
   - Тесты для `CSVLoader` — проверка загрузки и валидации CSV файлов
   - Проверка корректности структуры данных и наличия обязательных колонок

2. **Тесты ASGI приложения** ([`tests/test_asgi_app.py`](tests/test_asgi_app.py)):
   - Тесты для работы приложения через uvicorn ASGI интерфейс
   - Проверка доступности страниц через HTTP запросы
   - Тестирование стабильности при множественных запросах
   - Проверка обработки ошибок и несуществующих путей

### Запуск всех тестов

```bash
# через uv
uv run pytest

# либо напрямую
pytest
```

### Запуск конкретных тестов

```bash
# Только тесты загрузки данных
uv run pytest tests/test_data_loader.py

# Только тесты ASGI приложения
uv run pytest tests/test_asgi_app.py

# Тесты с подробным выводом
uv run pytest -vv

# Тесты с выводом print statements
uv run pytest -s

# Запуск конкретного теста
uv run pytest tests/test_asgi_app.py::test_asgi_app_root_path
```

### Дополнительные опции pytest

При запуске можно использовать стандартные опции pytest:

```bash
# Тихий режим (меньше вывода)
uv run pytest -q

# Очень подробный вывод
uv run pytest -vv

# Запуск тестов по паттерну имени
uv run pytest -k "asgi"

# Остановка на первой ошибке
uv run pytest -x

# Показать локальные переменные при ошибках
uv run pytest -l
```

### Асинхронные тесты

Тесты ASGI приложения используют асинхронные функции и требуют `pytest-asyncio`. Конфигурация находится в [`pyproject.toml`](pyproject.toml):

```toml
[tool.pytest.ini_options]
asyncio_mode = "auto"
```

Это позволяет автоматически определять и запускать асинхронные тесты без явного указания `@pytest.mark.asyncio` (хотя маркер можно использовать для явности).


## Линтинг и статический анализ

В проекте используются:
- **flake8** — линтер Python‑кода с поддержкой wemake-python-styleguide;
- **wemake-python-styleguide** — расширенный набор правил стиля кода (плагин для flake8);
- **mypy** — статический анализ типов.

Настройки находятся в [`setup.cfg`](setup.cfg) и [`pyproject.toml`](pyproject.toml).

### Запуск flake8 (с wemake-python-styleguide)

**wemake-python-styleguide** работает как плагин для flake8 и автоматически активируется при запуске flake8. Правила WPS проверяются вместе с базовыми правилами flake8.

```bash
# через uv
uv run flake8 app/

# либо напрямую (если flake8 установлен в окружении)
flake8 app/
```

Для проверки конкретных файлов:

```bash
uv run flake8 app/services/data_loader.py app/pages/home.py
```

### Запуск mypy

```bash
# через uv
uv run mypy app/

# либо напрямую
mypy app/
```

Для проверки конкретных файлов:

```bash
uv run mypy app/services/data_loader.py app/pages/home.py app/pages/region.py
```

mypy проверит соответствие аннотаций типов фактическому коду согласно конфигурации в [`setup.cfg`](setup.cfg).

### Запуск всех линтеров

Для проверки всего проекта можно запустить все линтеры последовательно:

```bash
# flake8 (включает проверки wemake-python-styleguide)
uv run flake8 app/

# mypy
uv run mypy app/
```


## Особенности реализации

### Визуализация на карте

На главной странице (`home.py`) реализована интерактивная карта России с кастомной палитрой цветов:
- **Зеленый** (0.85-1.0) — высокие значения метрики `value`
- **Желтый** (0.70-0.84) — средние значения
- **Красный** (<0.7) — низкие значения

Метрика `value` вычисляется как минимум из трех показателей организаций:
- `staffing` — отношение фактического количества работников к штатному расписанию
- `cash_use` — отношение фактически израсходованных средств к выделенным лимитам
- `serviceability` — доля исправной техники

### Валидация данных

Все данные проходят валидацию через Pydantic модели:
- CSV файлы валидируются при загрузке через `CSVLoader`
- GeoJSON файлы валидируются через модели в `app/models.py`
- Это обеспечивает типобезопасность и раннее обнаружение ошибок в данных

## Дополнительно

- Ноутбук [`service.ipynb`](service.ipynb) может использоваться как вспомогательный файл для отладки и прототипирования.
- `.gitignore` настроен для исключения виртуальных окружений, артефактов сборки и временных файлов.

Такое разделение на страницы, сервисный слой данных, модели валидации, тесты и линтеры делает проект удобным для развития, экспериментов с визуализацией и обучения архитектуре Dash‑приложений.