# Дашборд регионов России

## Описание

Этот проект — интерактивное веб‑приложение на базе фреймворка [Dash](https://dash.plotly.com/) для визуализации данных по регионам России.

Основные возможности:
- отображение карты России с регионами (GeoJSON‑геометрия);
- выбор региона и просмотр детализированной информации о нём;
- отображение аналитических показателей на основе подготовленных данных (`app/data/analytic`);
- навигация между страницами (главная, по регионам, архив и др.) через механизмы **Dash Pages**.

Приложение предназначено как учебный и демонстрационный пример архитектуры Dash‑проекта с:
- разбиением на страницы;
- отдельным слоем загрузки и подготовки данных (`data_loader`);
- базовыми автотестами и линтингом (flake8, wemake-python-styleguide, mypy, pytest).


## Архитектура

### Общий обзор

Приложение организовано как пакет `app` с точкой входа [`app/app.py`](app/app.py) и набором страниц в каталоге [`app/pages`](app/pages). Для работы с данными и геометрией регионов используется сервисный слой в [`app/services`](app/services).

Ключевые элементы архитектуры:

1. **Dash + Dash Pages**
   - В файле [`app/app.py`](app/app.py) создаётся объект `Dash` и включается поддержка страниц (Dash Pages).
   - Страницы описаны в модулях каталога [`app/pages`](app/pages):
     - [`app/pages/home.py`](app/pages/home.py) — главная страница с интерактивной картой России;
     - [`app/pages/region.py`](app/pages/region.py) — страница с деталями по конкретному региону.
   - Callbacks определены непосредственно в модулях страниц.

2. **Модели данных**

   - [`app/models.py`](app/models.py) — Pydantic модели для валидации данных:
     - `AnalyticRecord` — модель для аналитических данных из CSV;
     - `OrganizationRecord` — модель для данных об организациях из CSV;
     - `GeoJSONFeature`, `GeoJSONFeatureCollection` — модели для валидации GeoJSON данных.

3. **Сервисный слой**

   Сервисный слой инкапсулирует логику загрузки и подготовки данных:

   - [`app/services/csv_loader.py`](app/services/csv_loader.py) — загрузчик CSV файлов с валидацией:
     - `load_analytic_data()` — загрузка аналитических данных из `app/data/analytic/data.csv`;
     - `load_organizations_data()` — загрузка данных об организациях из `app/data/analytic/organizations.csv` с расчетом метрик (staffing, cash_use, serviceability) и колонки `value` (минимум из трех метрик);
     - `load_csv()` — универсальный метод для загрузки CSV с валидацией через Pydantic модели.

   - [`app/services/geojson_loader.py`](app/services/geojson_loader.py) — загрузчик GeoJSON файлов:
     - `load_and_validate_geojson_file()` — загрузка и валидация одного GeoJSON файла;
     - `GeoJSONLoader` — класс для загрузки всех регионов из каталога.

   - [`app/services/data_loader.py`](app/services/data_loader.py) — основной загрузчик данных:
     - `DataLoader` — класс, объединяющий геоданные и данные организаций в единый GeoDataFrame;
     - мерджит геометрию регионов (GeoJSON) с данными организаций по полю `region`;
     - предоставляет готовый `gdf` (GeoDataFrame) для использования в визуализации.

   Такой подход позволяет отделить бизнес‑логику от представления и упростить тестирование.

4. **Конфигурация**

   - [`app/config.py`](app/config.py) — конфигурационные параметры приложения (пути к данным, параметры запуска и т.п.).

5. **Данные**

   - [`app/data/analytic`](app/data/analytic) — табличные аналитические данные в CSV:
     - `data.csv` — аналитические данные по регионам;
     - `organizations.csv` — данные об организациях по регионам.
   - [`app/data/regions`](app/data/regions) — геоданные по регионам в формате GeoJSON:
     - отдельные файлы для каждого региона (например, `Adygeya.geojson`, `Moskva.geojson`);
     - [`app/data/regions/config`](app/data/regions/config) — конфигурационные файлы (regions_names.json, russia_regions.geojson, Russia.geojson).

6. **Тесты**

   - Каталог [`tests`](tests) содержит автоматические тесты:
     - [`tests/test_data_loader.py`](tests/test_data_loader.py) — тесты для сервисов загрузки данных (проверка корректности чтения CSV/GeoJSON, сопоставления регионов, валидации данных и т.д.).


## Структура проекта

Основные элементы дерева проекта:

```text
.
├── app/
│   ├── app.py              # Точка входа Dash-приложения
│   ├── config.py           # Конфигурация приложения
│   ├── models.py           # Pydantic модели для валидации данных
│   ├── data/
│   │   ├── analytic/
│   │   │   ├── data.csv              # Аналитические данные по регионам
│   │   │   └── organizations.csv    # Данные об организациях
│   │   └── regions/
│   │       ├── *.geojson            # Геометрия отдельных регионов
│   │       └── config/
│   │           ├── regions_names.json
│   │           ├── russia_regions.geojson
│   │           └── Russia.geojson
│   ├── pages/
│   │   ├── __init__.py
│   │   ├── home.py                  # Главная страница с картой России
│   │   └── region.py                # Страница деталей региона
│   └── services/
│       ├── __init__.py
│       ├── csv_loader.py            # Загрузчик CSV с валидацией
│       ├── geojson_loader.py        # Загрузчик GeoJSON файлов
│       └── data_loader.py           # Основной загрузчик данных
├── tests/
│   ├── __init__.py
│   └── test_data_loader.py          # Тесты для сервисов загрузки данных
├── pyproject.toml          # Зависимости (uv) и базовая конфигурация
├── setup.cfg               # Настройки инструментов (flake8, mypy и др.)
├── uv.lock                 # Lock-файл зависимостей для uv
└── README.md
```


## Запуск приложения

Ниже предполагается, что у вас установлен Python 3.11+ и инструмент [uv](https://github.com/astral-sh/uv) (если проект на нём). Если вы используете `pip`, шаги по установке пакетов будут немного отличаться.

### 1. Клонирование репозитория

```bash
git clone <URL_РЕПОЗИТОРИЯ>
cd dashbord
```

### 2. Установка зависимостей

Через **uv** (рекомендуется, если проект уже настроен под uv, см. [`pyproject.toml`](pyproject.toml) и [`uv.lock`](uv.lock)):

```bash
uv sync
```

Через **pip** (альтернативный вариант):

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -e .  # установка из pyproject.toml
```

### 3. Запуск Dash-приложения

Как правило, используется модуль [`app/app.py`](app/app.py) с объявлением `server` или `app`.

Примеры команд (конкретная команда может отличаться, см. `pyproject.toml`):

```bash
# Вариант 1: через uv
uv run python -m app.app

# Вариант 2: обычный запуск python
python -m app.app

# либо
python app/app.py
```

После запуска приложение будет доступно по адресу, указанному в логах (обычно http://127.0.0.1:8050/ или порт из `.env`).


## Тестирование

Для тестов используется **pytest**. Тесты лежат в каталоге [`tests`](tests).

### Запуск всех тестов

```bash
# через uv
uv run pytest

# либо напрямую
pytest
```

При запуске можно использовать стандартные опции pytest, например `-q`, `-vv`, `-k <pattern>`.


## Линтинг и статический анализ

В проекте используются:
- **flake8** — линтер Python‑кода с поддержкой wemake-python-styleguide;
- **wemake-python-styleguide** — расширенный набор правил стиля кода (плагин для flake8);
- **mypy** — статический анализ типов.

Настройки находятся в [`setup.cfg`](setup.cfg) и [`pyproject.toml`](pyproject.toml).

### Запуск flake8 (с wemake-python-styleguide)

**wemake-python-styleguide** работает как плагин для flake8 и автоматически активируется при запуске flake8. Правила WPS проверяются вместе с базовыми правилами flake8.

```bash
# через uv
uv run flake8 app/

# либо напрямую (если flake8 установлен в окружении)
flake8 app/
```

Для проверки конкретных файлов:

```bash
uv run flake8 app/services/data_loader.py app/pages/home.py
```

### Запуск mypy

```bash
# через uv
uv run mypy app/

# либо напрямую
mypy app/
```

Для проверки конкретных файлов:

```bash
uv run mypy app/services/data_loader.py app/pages/home.py app/pages/region.py
```

mypy проверит соответствие аннотаций типов фактическому коду согласно конфигурации в [`setup.cfg`](setup.cfg).

### Запуск всех линтеров

Для проверки всего проекта можно запустить все линтеры последовательно:

```bash
# flake8 (включает проверки wemake-python-styleguide)
uv run flake8 app/

# mypy
uv run mypy app/
```


## Особенности реализации

### Визуализация на карте

На главной странице (`home.py`) реализована интерактивная карта России с кастомной палитрой цветов:
- **Зеленый** (0.85-1.0) — высокие значения метрики `value`
- **Желтый** (0.70-0.84) — средние значения
- **Красный** (<0.7) — низкие значения

Метрика `value` вычисляется как минимум из трех показателей организаций:
- `staffing` — отношение фактического количества работников к штатному расписанию
- `cash_use` — отношение фактически израсходованных средств к выделенным лимитам
- `serviceability` — доля исправной техники

### Валидация данных

Все данные проходят валидацию через Pydantic модели:
- CSV файлы валидируются при загрузке через `CSVLoader`
- GeoJSON файлы валидируются через модели в `app/models.py`
- Это обеспечивает типобезопасность и раннее обнаружение ошибок в данных

## Дополнительно

- Ноутбук [`service.ipynb`](service.ipynb) может использоваться как вспомогательный файл для отладки и прототипирования.
- `.gitignore` настроен для исключения виртуальных окружений, артефактов сборки и временных файлов.

Такое разделение на страницы, сервисный слой данных, модели валидации, тесты и линтеры делает проект удобным для развития, экспериментов с визуализацией и обучения архитектуре Dash‑приложений.